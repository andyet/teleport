## Overview

This is a conceptual doc about the Teleport Authentication Service and Certificate Management. This doc will explain how Users and Nodes are identified and granted access to Nodes and Services.

[TOC]

## Authentication vs. Authorization

Teleport Auth handles both authentication and authorization. These topics are related but different and they are often discussed jointly as "Auth".

**Authentication** is proving an identity. "I say I am Bob, and I really am Bob. See look I have Bob's purple hat.". The job of an Authentication system is to define the criterion by which users must prove their identity. Is having a purple hat enough to show that a person is Bob? Maybe, maybe not. To identify users and nodes to Teleport Auth we require them to present a cryptographically-signed certificate issued by the Teleport Auth Certificate Authority.

**Authorization** is proving access to something: "Bob has a purple hat, but also a debit card and the correct PIN code. Bob can access a bank account with the number 814000001344. Can Bob get $20 out of the ATM?". The ATM's Authentication system would validate Bob's PIN Code, while the Authorization system would use a stored mapping from Bob to Account 814000001344 to decide whether Bob could withdraw cash. Authorization defines and determines permissions that users have within a system, such as access to cash within a banking system or data in a filesystem. Before users are granted access to nodes, the Auth Service checks their identity against a stored mapping in a database.

<!--TODO: Diagram-->

## SSH Certificates

One can think of an SSH certificate as a "permit" issued and time-stamped by a trusted authority. In this case the authority is the auth server Certificate Authority. A certificate contains four important pieces of data:

1. List of principals (identities) this certificate belongs to.
2. Signature of the certificate authority who issued it, i.e. the _auth server_.
3. The expiration date, also known as "time-to-live" or simply TTL.
4. Additional data, often stored as a certificate extension.

## Authentication in Teleport

Teleport uses SSH certificates to authenticate nodes and users within a cluster.

There are two CAs operating inside the Auth Server because cluster nodes and users each need their own certificates. <!--TODO: Explain this more-->

* The **Node CA** issues certificates which identify a node (i.e. host, server, computer). These certificates are used to add new nodes to a cluster and identify connections coming from the node.
* The **User CA** issues certificates which identify a User. These certificates are used to authenticate users when they try to connect to a cluster node.

### Issuing Node Certificates

Node Certificates identify a node within a cluster and establish the permissions of the node to access to other Teleport services. The presence of a signed certificate on a node makes it a cluster member.

<!--TODO Diagram of cluster join in the vein of others system graphics-->

1) To join a cluster for the first time, a node must present a "join token" to the auth server.
The token can be [static (configured via config)](../configuration) or a dynamic, single-use token generated by [`tctl nodes add`](../cli-docs/#tctl-nodes).

!!! tip "Token TTL":
    When using dynamic tokens, their default time to live (TTL) is 15 minutes, but it can be
    reduced (not increased) via [`tctl nodes add --ttl`](../cli-doocs/#tctl-nodes) flag.

2) When a new node joins the cluster, the auth server generates a new public/private keypair for the node and signs its certificate <!--where is it stored?-->. This node certificate contains the node's role(s) (`proxy`, `auth` or `node`) as a certificate extension (opaque signed string).

### Using Node Certificates

All nodes in a cluster can connect to the Auth Server's API <!--Docs about this--> implemented as an HTTP REST service running over the SSH tunnel. This API connection is authenticated with the node certificate and the encoded role is checked to enforce access control. For example, a client connection using a certificate with only the `node` role won't be able to add and delete users. This client connection would only be authorized to get auth servers registered in the cluster.

### Issuing User Certificates

The Auth Server uses its User CA to issue user certificates. In addition to
user's identity, user certificates also contain user roles and SSH options,
like "permit-agent-forwarding" <!--TODO: link to config/set options here-->.

This additional data is stored as a certificate extension and is protected by the CA
signature.

### Using User Certificates

TODO: Diagram
TODO: Client Identity
TODO: Client Authorization to Node

## Certificate Rotation

By default, all user certificates have an expiration date, also known as time to
live (TTL). This TTL can be configured by a Teleport administrator. But the
node certificates issued by an Auth Server are valid indefinitely by default.

Teleport supports certificate rotation, i.e. the process of invalidating all previously-issued certificates for nodes _and_ users regardless of their TTL. Certificate rotation is
triggered by [`tctl auth rotate`](../cli-docs/#tctl-auth). When this command is invoked by a Teleport administrator on one of cluster's Auth Servers, the following happens:

1. A new certificate authority (CA) key is generated.
2. The old CA will be considered valid _alongside_ the new CA for some period of
  time. This period of time is called a _grace period_ TODO: Link to config/defaults.
3. During the grace period, all previously issued certificates will be considered
  valid, assuming their TTL isn't expired.
4. After the grace period is over, the certificates issued by the old CA are no
  longer accepted.

This process is repeated twice, one for the node CA and once for the user CA.

Take a look at the [Certificate Guide](../guides/certificate-rotation) to learn how to do certificate rotation in practice.

## Auth API

 <!--TODO-->.

Clients can also connect to the auth API through the Teleport proxy to use a limited subset of the API to discover the member nodes of the cluster.

## Auth State

<!--When the Auth Service starts for the first time, it generates a public/private keypair and stores it in the configurable key storage.-->

The Auth service maintains state using a database of users, credentials, certificates, and audit logs. The default storage location is `/var/lib/teleport` or an [admin-configured storage destination](../configuration#storage).

There are three types of data stored by the auth server:

* Cluster State. The auth server stores its own keys in a cluster state storage. All of cluster dynamic configuration is stored there as well, including:
    * Node membership information and online/offline status for each node.
    * List of active sessions.
    * List of locally stored users
    * RBAC configuration (roles and permissions).
    * Other dynamic configuration.
* Audit Log. When users log into a Teleport cluster, execute remote commands and logout, that activity is recorded in the audit log. See Audit Log for more details.
* Recorded Sessions. When Teleport users launch remote shells via tsh ssh command, their interactive sessions are recorded and stored by the auth server. Each recorded session is a file which is saved in /var/lib/teleport by default, but can also be saved in external storage, like an AWS S3 bucket.


## More Concepts

* [Basics](./basics)
* [Users](./users)
* [Nodes](./nodes)
* [Proxy](./proxy)
* [Architecture](./architecture)